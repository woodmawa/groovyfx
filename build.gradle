/*
 * SPDX-License-Identifier: Apache-2.0
 *
 * Copyright 2011-2021 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*
 * SPDX-License-Identifier: Apache-2.0
 */
plugins {
    id 'groovy'
    id 'java-library'
    id 'idea'
    id 'jacoco'
    id 'maven-publish'
    id 'org.openjfx.javafxplugin' version '0.1.0'
}

group = (findProperty('group') ?: 'org.groovyfx') as String
version = (findProperty('version') ?: '0.0.0-SNAPSHOT') as String

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
    withJavadocJar()
    withSourcesJar()
}

jacoco {
    toolVersion = '0.8.14'
}


repositories {
    mavenCentral()
    // optionally enable this for local testing:
    // if (findProperty('groovyfx_useMavenLocal')?.toString()?.toBoolean()) mavenLocal()
}

def groovyVersion = (findProperty('groovyfx_groovyVersion') ?: '5.0.3') as String
def javafxVersion = (findProperty('groovyfx_javafxVersion') ?: '25.0.1') as String
def spockVersion  = (findProperty('groovyfx_spockVersion')  ?: '2.4-M7-groovy-5.0') as String
def jansiVersion  = (findProperty('groovyfx_jansiVersion')  ?: '2.4.1') as String

javafx {
    version = javafxVersion
    // keep broad module set for GroovyFX (trim later once build is green)
    modules = [
            'javafx.base',
            'javafx.graphics',
            'javafx.controls',
            'javafx.fxml',
            'javafx.web',
            'javafx.media'
    ]
}

/**
 * AST bootstrap:
 * - compileAstGroovy must produce FXBindable + FXBindableASTTransformation before main sources compile
 * - Avoid compileAstJava/compileAstGroovy cycles by doing JOINT compilation in compileAstGroovy:
 *   * ast Groovy srcDirs include src/ast/groovy AND src/ast/java (so Java AST transform compiles there)
 *   * ast Java srcDirs is EMPTY (so compileAstJava is NO-SOURCE)
 */
sourceSets {
    ast {
        groovy.srcDirs = ['src/ast/groovy', 'src/ast/java']
        java.srcDirs   = [] // critical: prevents compileAstJava sources & avoids task cycles
        resources.srcDirs = ['src/ast/resources']

        // allow AST compilation to reuse normal dependencies if needed
        compileClasspath += sourceSets.main.compileClasspath
        runtimeClasspath += output + compileClasspath
    }
}

configurations {
    astImplementation.extendsFrom implementation
    astCompileOnly.extendsFrom compileOnly
    astRuntimeOnly.extendsFrom runtimeOnly
}

dependencies {
    // AST source set needs Groovy too (separate source set = separate classpath)
    astImplementation platform("org.apache.groovy:groovy-bom:${groovyVersion}")
    astImplementation "org.apache.groovy:groovy"

    // Use Groovy 5 BOM to keep Groovy modules aligned
    api platform("org.apache.groovy:groovy-bom:${groovyVersion}")
    api "org.apache.groovy:groovy"

    // TEMP: SceneGraphBuilder imports groovy.swing.*; keep until we refactor it out
    //implementation "org.apache.groovy:groovy-swing"

    // JavaFX dependencies are supplied by org.openjfx plugin via the 'javafx { }' block

    // Jansi (legacy console support)
    implementation "org.fusesource.jansi:jansi:${jansiVersion}"

    // Testing (Spock runs on JUnit Platform)
    testImplementation platform("org.apache.groovy:groovy-bom:${groovyVersion}")
    testImplementation "org.spockframework:spock-core:${spockVersion}"
    testImplementation("org.apache.groovy:groovy-test:${spockVersion}")
    testRuntimeOnly "org.junit.platform:junit-platform-launcher"
}

// Ensure main compilation sees the compiled AST output (annotation + transform)
tasks.named('compileGroovy', GroovyCompile).configure {
    dependsOn(tasks.named('compileAstGroovy'))
    classpath += sourceSets.ast.output
}
tasks.named('compileJava', JavaCompile).configure {
    dependsOn(tasks.named('compileAstGroovy'))
    classpath += sourceSets.ast.output
}

tasks.withType(GroovyCompile).configureEach {
    groovyOptions.encoding = 'UTF-8'
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    options.release = 25
}

test {
    useJUnitPlatform()
}

// Publishing: keep minimal/standard to avoid Gradle 9 DSL issues
publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
        }
    }
}

// IntelliJ/Gradle sometimes calls 'version' task; keep it around
tasks.register("version") {
    group = "Help"
    description = "Prints the project version."
    doLast {
        println(project.version)
    }
}

// Make AST (FXBindable + transform) visible to tests too
tasks.named('compileTestGroovy', GroovyCompile).configure {
    dependsOn(tasks.named('compileAstGroovy'))
    classpath += sourceSets.ast.output
}

tasks.named('compileTestJava', JavaCompile).configure {
    dependsOn(tasks.named('compileAstGroovy'))
    classpath += sourceSets.ast.output
}

// avoid instrumenting JDK internals and similar
tasks.withType(Test).configureEach {
    jacoco {
        excludes = ['java/**', 'javax/**', 'jdk/**', 'sun/**', 'com/sun/**']
    }
}

//hide native access warnings - clearer to read
tasks.withType(Test).configureEach {
    jvmArgs '--enable-native-access=ALL-UNNAMED'
}
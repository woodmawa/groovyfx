/*
 * SPDX-License-Identifier: Apache-2.0
 *
 * Copyright 2011-2021 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
plugins {
    id 'groovy'
    id 'java-library'
    id 'idea'
    id 'jacoco'
    id 'maven-publish'
    id 'org.openjfx.javafxplugin' version '0.1.0'
}

group = (findProperty('group') ?: 'org.groovyfx') as String
version = (findProperty('version') ?: '0.0.0-SNAPSHOT') as String

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
    withJavadocJar()
    withSourcesJar()
}

repositories {
    mavenCentral()
    // optionally enable this for local testing:
    // if (findProperty('groovyfx_useMavenLocal')?.toString()?.toBoolean()) mavenLocal()
}

def groovyVersion = (findProperty('groovyfx_groovyVersion') ?: '5.0.3') as String
def javafxVersion = (findProperty('groovyfx_javafxVersion') ?: '25.0.1') as String
def spockVersion  = (findProperty('groovyfx_spockVersion')  ?: '2.4-M7-groovy-5.0') as String
def jansiVersion  = (findProperty('groovyfx_jansiVersion')  ?: '2.4.1') as String

javafx {
    version = javafxVersion
    // keep broad module set for GroovyFX (trim later once build is green)
    modules = [
            'javafx.base',
            'javafx.graphics',
            'javafx.controls',
            'javafx.fxml',
            'javafx.swing',
            'javafx.web',
            'javafx.media'
    ]
}

dependencies {
    // Use Groovy 5 BOM to keep Groovy modules aligned
    api platform("org.apache.groovy:groovy-bom:${groovyVersion}")
    api "org.apache.groovy:groovy"

    // If GroovyFX uses additional Groovy modules, uncomment as needed:
    // implementation "org.apache.groovy:groovy-xml"
    // implementation "org.apache.groovy:groovy-json"
    // implementation "org.apache.groovy:groovy-swing"

    // Jansi (your old build had a dedicated configuration; keep it simple first)
    implementation "org.fusesource.jansi:jansi:${jansiVersion}"

    // Testing (Spock runs on JUnit Platform)
    testImplementation platform("org.apache.groovy:groovy-bom:${groovyVersion}")
    testImplementation "org.spockframework:spock-core:${spockVersion}"
    testRuntimeOnly "org.junit.platform:junit-platform-launcher"
}

tasks.withType(GroovyCompile).configureEach {
    groovyOptions.encoding = 'UTF-8'
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    // You said “compile and run with Java 25” — keep release=25.
    options.release = 25
}

test {
    useJUnitPlatform()
    // JavaFX tests sometimes need extra flags; leave empty until we see failures.
    // jvmArgs += ['-Dprism.order=sw', '-Djavafx.animation.pulse=10']
}

jacoco {
    toolVersion = '0.8.12'
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            pom {
                name = 'GroovyFX'
                description = 'A library for writing JavaFX applications in the Groovy language'
                url = 'https://github.com/groovyfx-project/groovyfx'
                licenses {
                    license {
                        name = 'Apache License, Version 2.0'
                        url = 'https://www.apache.org/licenses/LICENSE-2.0.txt'
                    }
                }
                scm {
                    url = 'https://github.com/groovyfx-project/groovyfx'
                }
            }
        }
    }
}

//added to help gradle 9.1 resolve build
tasks.register("version") {
    group = "Help"
    description = "Prints the project version."
    doLast {
        println(project.version)
    }
}